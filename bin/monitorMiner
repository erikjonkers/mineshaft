#!/bin/bash
NVIDIASMI=$(which nvidia-smi)

TW=0
TotalFanspeed=0
GPUstatus=$($NVIDIASMI)

for fanspeed in $(echo $GPUstatus | grep Default | awk '{print $2}'); do   
	myFanspeed=$(echo $fanspeed |sed s/\%$//g);  
	TotalFanspeed=$(($TotalFanspeed + $myFanspeed)); 
done;

if test $TotalFanspeed -lt 100; then 
	echo "doing setup"
	/root/mineshaft/bin/setup1070
fi

for w in $(echo $GPUstatus | grep Default | awk '{print $5}'); do   
	mywatt=$(echo $w |sed s/W$//g);  
	TW=$(($TW + $mywatt)); 
done;

#called with 'force' argument?
if [ "$1" == "force" ]; then
	TW=1
fi

echo "Fans: $TotalFanspeed"
echo "power: $TW"
if test $TW -lt 150; then 
	echo "restart"; 
	/root/mineshaft/bin/ethminerStart
fi

